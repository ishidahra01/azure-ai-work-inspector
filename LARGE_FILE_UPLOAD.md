# 大容量ファイルアップロード対応について

## 概要

このアプリケーションは、1GB以上の大容量動画ファイルをアップロードする際の「AxiosError: Request failed with status code 400」エラーを解決するため、チャンクアップロード機能を実装しています。

## 実装内容

### 1. チャンクアップロード機能 (`utils/file_upload.py`)

- **ChunkedFileUploader クラス**: 
  - デフォルト8MBのチャンクサイズでファイルを読み込み
  - プログレスバー表示機能
  - ファイル整合性チェック（MD5ハッシュ）
  - メモリ効率的な処理

- **StreamedFileHandler クラス**:
  - 大容量ファイルのコピー処理
  - プログレス表示付きのファイル操作

### 2. Streamlit設定 (`.streamlit/config.toml`)

- 最大アップロードサイズを5GBに設定
- メッセージサイズ制限を増加
- ファイルウォッチャーの最適化

### 3. 設定管理 (`config.py`)

- アップロードサイズ制限の設定
- サポートされる動画形式の定義
- エラーメッセージの一元管理
- チャンクサイズとプログレス更新頻度の設定

### 4. エラーハンドリングの改善

- 詳細なエラーメッセージ
- 一時ファイルの自動クリーンアップ
- 処理キャンセル機能
- メモリリーク防止

## 使用方法

### 1. 環境設定

```bash
# 依存関係のインストール
pip install -r requirements.txt
```

### 2. アプリケーション起動

#### Windows:
```bash
start_app.bat
```

#### Linux/Mac:
```bash
cd apps
streamlit run app.py --server.maxUploadSize=5000
```

### 3. 大容量ファイルのアップロード

1. サイドバーで解析パラメータを設定
2. 動画ファイルを選択（最大5GB）
3. ファイル情報とサイズが表示される
4. 「Process Video」ボタンをクリック
5. プログレスバーでアップロード進行状況を確認

## トラブルシューティング

### アップロードエラーが発生する場合

1. **ファイルサイズ確認**: 5GB以下であることを確認
2. **ディスク容量**: 十分な空き容量があることを確認
3. **メモリ**: 処理には動画ファイルサイズの2-3倍のRAMが推奨
4. **ネットワーク**: 安定したインターネット接続を確認

### メモリ不足エラーの場合

- `config.py`の`CHUNK_SIZE_MB`を小さくする（例：4MB）
- システムのメモリを増やす
- 他のアプリケーションを終了する

### 処理が停止した場合

- 「Cancel Processing」ボタンで処理をキャンセル
- 一時ファイルは自動的にクリーンアップされる
- アプリケーションを再起動

## 技術的な詳細

### チャンクサイズの選択

- **8MB（デフォルト）**: 一般的な環境で最適なバランス
- **4MB**: メモリが少ない環境向け
- **16MB**: 高速ネットワークと十分なメモリがある環境向け

### メモリ使用量

従来の実装では動画ファイル全体をメモリに読み込んでいましたが、新しい実装では：

- メモリ使用量 ≈ チャンクサイズ × 2-3
- 1GBファイルでも約24-48MBのメモリ使用量

### セキュリティ考慮事項

- ファイル整合性チェック（MD5ハッシュ）
- 一時ファイルの安全な作成と削除
- ファイルタイプの検証
- サイズ制限の強制

## パフォーマンス最適化

### 大容量ファイル向けの推奨設定

```python
# config.py
CHUNK_SIZE_MB = 16  # 高速ネットワーク向け
PROGRESS_UPDATE_INTERVAL = 2 * 1024 * 1024  # 2MBごとに更新
```

### 低スペック環境向けの設定

```python
# config.py
CHUNK_SIZE_MB = 4  # メモリ使用量を削減
MAX_UPLOAD_SIZE_GB = 2  # アップロードサイズを制限
```

## 今後の改善点

1. **並列処理**: 複数チャンクの並列アップロード
2. **レジューム機能**: 中断されたアップロードの再開
3. **圧縮**: アップロード前の動的圧縮
4. **プレビュー**: アップロード前の動画プレビュー
5. **バッチ処理**: 複数ファイルの同時処理
